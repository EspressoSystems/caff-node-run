#!/bin/sh
# Run JSON config validator on staged JSON files and block commit on errors.

set -e

# Gather staged JSON files (Added, Copied, or Modified)
STAGED_JSON=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.json$' || true)

if [ -z "$STAGED_JSON" ]; then
  # Nothing to validate
  echo "No staged JSON files to validate."
  exit 0
fi

FAILED=0

for file in $STAGED_JSON; do
  # validate only files that still exist in the worktree
  
  if [ -f "$file" ]; then

    echo "Validating $file..."
    python3 scripts/validate_schema.py "$file"
    rc=$?
    if [ $rc -ne 0 ]; then
      echo "Validation failed for $file"
      FAILED=1
    fi

    DIFF=$(git diff --cached "$file")

    # Check for Ethereum private keys (0x + 64 hex characters)
    if echo "$DIFF" | grep -qE '^\+.*"private-key"\s*:\s*"0x[0-9a-fA-F]{64}'; then
        echo ""
        echo "‚ùå ERROR: Actual private key detected in $file!"
        echo "   Use 'ADD_PRIVATE_KEY' or '...' instead of real keys"
        echo ""
        FAILED=1
    fi
    
    # Check for suspiciously long alphanumeric strings
    if echo "$DIFF" | grep -qE '^\+.*"private-key"\s*:\s*"[a-zA-Z0-9]{50,}"'; then
        echo ""
        echo "‚ö†Ô∏è  WARNING: Suspicious private key format in $file"
        echo "   Use 'ADD_PRIVATE_KEY' or '...' instead"
        echo ""
        FAILED=1
    fi

    # Check for API keys with common patterns
    # AWS Access Key (AKIA prefix followed by 16 alphanumeric characters)
    if echo "$DIFF" | grep -qE '^\+.*AKIA[0-9A-Z]{16}'; then
        echo ""
        echo "‚ùå ERROR: AWS Access Key detected in $file!"
        echo "   Use environment variables or secret management instead"
        echo ""
        FAILED=1
    fi

    # Check for common API key patterns
    # Generic API key patterns: "api_key" or "apiKey" or "API_KEY" followed by alphanumeric string
    if echo "$DIFF" | grep -qE '^\+.*(api[_-]?key|apikey|API[_-]?KEY|secret[_-]?key|secretkey|SECRET[_-]?KEY)\s*[\":=]\s*"?[a-zA-Z0-9_\-]{20,}'; then
        echo ""
        echo "‚ùå ERROR: Potential API key/secret detected in $file!"
        echo "   Use environment variables or secret management instead"
        echo ""
        FAILED=1
    fi

    # Check for API keys embedded in URLs
    if echo "$DIFF" | grep -qE '^\+.*(https?|wss?)://[^\"]*/[0-9a-fA-F]{32,}'; then
        echo ""
        echo "‚ùå ERROR: Possible API key embedded in URL in $file!"
        echo "   Use environment variables or secret management instead"
        echo ""
        FAILED=1
    fi
  fi
done

if [ $FAILED -ne 0 ]; then
  echo "\n üö´ Commit aborted: JSON validation errors present (warnings allowed)."
  exit 1
fi

exit 0